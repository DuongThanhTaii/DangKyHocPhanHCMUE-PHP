# Docker Compose for Testing Environment
# This creates an isolated testing environment with:
# - PHP Backend with all dependencies
# - PostgreSQL test database (populated with migrations + seeders)
# - Redis for cache/locks

services:
  # PHP Laravel Backend for Testing
  backend-php:
    build:
      context: ./backend_php
      dockerfile: Dockerfile.test
    container_name: dkhp-backend-php-test
    working_dir: /var/www/html
    volumes:
      - ./backend_php:/var/www/html
    environment:
      - APP_ENV=testing
      - APP_KEY=${APP_KEY:-base64:test_key_for_testing_only_32chars=}
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres-test
      - DB_PORT=5432
      - DB_DATABASE=dkhp_test
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres_test
      - REDIS_HOST=redis-test
      - REDIS_PORT=6379
      - CACHE_STORE=redis
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - dkhp-test-network

  # PostgreSQL Test Database
  postgres-test:
    image: postgres:15-alpine
    container_name: dkhp-postgres-test
    environment:
      - POSTGRES_DB=dkhp_test
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres_test
    ports:
      - "5433:5432"  # Different port to avoid conflict with production
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    networks:
      - dkhp-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d dkhp_test"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis for Testing
  redis-test:
    image: redis:7-alpine
    container_name: dkhp-redis-test
    ports:
      - "6380:6379"  # Different port to avoid conflict
    networks:
      - dkhp-test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  dkhp-test-network:
    driver: bridge

volumes:
  postgres-test-data:
